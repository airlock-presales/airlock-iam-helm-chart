{{- $fullName := include "airlock-iam.fullname" . -}}
{{- if eq .Values.iam.appDeploymentStrategy "single" -}}
{{-   $_ := set . "IAM" (dict "fullName" $fullName
                              "suffix" ""
                              "module" (include "airlock-iam.listActiveModules" .)
                              "instanceRef" .Values.iam.combined.instancePropertiesRef
                              "persistenceRef" .Values.iam.combined.persistenceRef
                              "healthChecksRef" .Values.iam.combined.healthChecksRef
                              "app_values" .Values.iam.combined ) }}
---
{{-   tpl ($.Files.Get "include/_statefulset.yaml") . -}}

{{- else if eq .Values.iam.appDeploymentStrategy "multi" -}}
{{-   range $app, $app_values := .Values.iam.apps -}}
{{-     if $app_values.enable -}}
{{-       $_ := set $ "IAM" (dict "fullName" $fullName
                                  "suffix" ($app_values.dedicatedDeployment.suffix | default (include "airlock-iam.mapAppName" $app))
                                  "module" (include "airlock-iam.mapAppName" $app)
                                  "instanceRef" $app_values.dedicatedDeployment.instancePropertiesRef
                                  "persistenceRef" $app_values.dedicatedDeployment.persistenceRef
                                  "healthChecksRef" $app_values.dedicatedDeployment.healthChecksRef
                                  "app_values" $app_values.dedicatedDeployment ) }}
---
{{-       tpl ($.Files.Get "include/_statefulset.yaml") $ -}}
{{-     end -}}
{{-   end -}}
{{- else -}}
{{-   fail "Invalid value for iam.appDeploymentStrategy" }}
{{- end -}}
