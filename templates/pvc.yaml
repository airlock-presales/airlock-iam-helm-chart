{{- $fullName := include "airlock-iam.fullname" . -}}
{{- if eq .Values.iam.appDeploymentStrategy "single" -}}
{{-   $_ := set . "IAM" (dict "fullName" $fullName
                              "suffix" ""
                              "persistenceRef" .Values.iam.combined.persistenceRef) -}}
---
{{-   tpl ($.Files.Get "include/_pvc.yaml") . -}}

{{- else if eq .Values.iam.appDeploymentStrategy "multi" -}}
{{-   range $app, $app_values := .Values.iam.apps -}}
{{-     if $app_values.enable -}}
{{-       $_ := set $ "IAM" (dict "fullName" $fullName
                                  "suffix" ($app_values.dedicatedDeployment.suffix | default (include "airlock-iam.mapAppName" $app))
                                  "persistenceRef" $app_values.dedicatedDeployment.persistenceRef) -}}
---
{{-       tpl ($.Files.Get "include/_pvc.yaml") $ -}}
{{-     end -}}
{{-   end -}}

{{- else -}}
{{-   fail "Invalid value for iam.appDeploymentStrategy" }}
{{- end -}}
