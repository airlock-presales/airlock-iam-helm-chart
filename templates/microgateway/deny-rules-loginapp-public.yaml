{{- if eq .Values.ingress.type "microgateway" -}}
{{-   $app := "loginapp" -}}
{{-   $fullName := include "airlock-iam.fullname" . -}}
{{-   $app_values := get .Values.iam.apps $app -}}
{{-   $suffix := $app_values.dedicatedDeployment.suffix | default (include "airlock-iam.mapAppName" $app) -}}
{{-   $moduleName := print $fullName "-" $suffix | lower -}}
{{-   $moduleType := include "airlock-iam.mapAppName" $app -}}
{{-   if $app_values.enable }}
apiVersion: microgateway.airlock.com/v1alpha1
kind: DenyRules
metadata:
  name: {{ $moduleName }}-rest-public
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "airlock-iam.labels" $ | nindent 4 }}
    app.kubernetes.io/component: {{ $moduleType }}
  annotations:
    {{- include "airlock-iam.annotations" $ | nindent 4 }}
spec:
  request:
    builtIn:
      settings:
        level: Strict
        threatHandlingMode: Block
# SSRF deny rule introduced in Microgateway 4.4
      {{- if semverCompare ">=4.4" .Values.ingress.microgateway.version }}
      overrides:
        - conditions:
            ruleKeys:
              - SSRF
            types:
              - JSON
          settings:
            level: Unfiltered
      {{- end }}
      exceptions:
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-servers/[a-zA-Z0-9._\\-]+/authorize/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$.consentToken"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-server/consent/remote/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^consent_token$"
                ignoreCase: false
        requestConditions:
          invert: false
          method:
          - "GET"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/oauth2-confirm/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.id"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/registration/attestation-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.attestationObject"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/registration/attestation-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.id"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.userHandle"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.signature"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.authenticatorData"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$.jwt"
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/(authentication|self-service)/device-token/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.id"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/self-service/approval/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.userHandle"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/self-service/approval/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.signature"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/self-service/approval/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            value:
              matcher:
                regex: "^[a-zA-Z0-9_\\-]*$"
                ignoreCase: false
            jsonPath: "$.publicKeyCredential.response.authenticatorData"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/self-service/approval/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$.email"
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$['username','representeeName']"
      - ruleKeys:
        - "SQL"
        blockedData:
          json:
            jsonPath: "$.data.email"
      - ruleKeys:
        - "SQL"
        blockedData:
          header:
            source: Any
            name:
              matcher:
                regex: "^X-IAM-SSO-Ticket$"
            value:
              matcher:
                regex: "^[a-zA-Z0-9_.\\-]+$"
                ignoreCase: false
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/(?:location|default-application|applications/[a-z0-9_\\-]+)/access/?$"
              ignoreCase: false
      - ruleKeys:
        - "SQL"
        blockedData:
          header:
            source: Any
            name:
              matcher:
                regex: "^X-Captcha-Solution$"
      - ruleKeys:
        - "XSS"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^filter$"
                ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          json:
            jsonPath: "$.location"
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/location/(access|interpret)/?$"
              ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.clientDataJSON"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.clientDataJSON"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/registration/attestation-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/client/authorization/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-servers/[a-zA-Z0-9._\\-]+/authorize/?$"
              ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^Location$"
                ignoreCase: false
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/ui/configuration/logout/?$"
              ignoreCase: false
      - ruleKeys:
        - "XSS"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "TEMPLATE"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "HTML"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "UNIXCMD"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "UNIXCMD"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-servers/[a-zA-Z0-9._\\-]+/authorize/?$"
              ignoreCase: false
      - ruleKeys:
        - "WINCMD"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "LDAP"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "LDAP"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^(?:sso|ticket|representation)$"
                ignoreCase: false
      - ruleKeys:
        - "PHP"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "OGNL"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.consentToken"
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-server/consent/remote/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.id"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/registration/attestation-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.attestationObject"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/registration/attestation-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.id"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.userHandle"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.signature"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.authenticatorData"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.jwt"
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/(authentication|self-service)/device-token/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.clientDataJSON"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/assertion-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.publicKeyCredential.response.clientDataJSON"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/fido/registration/attestation-response/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/client/authorization/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-servers/[a-zA-Z0-9._\\-]+/authorize/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          json:
            jsonPath: "$.location"
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/location/(access|interpret)/?$"
              ignoreCase: false
      - ruleKeys:
        - "IDOR"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^Location$"
                ignoreCase: false
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/ui/configuration/logout/?$"
              ignoreCase: false
      - ruleKeys:
        - "NOSQL"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "SANITY"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "ENCODING"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^(?:sso|ticket|representation)$"
                ignoreCase: false
      - ruleKeys:
        - "ENCODING"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "PROTOCOL"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "HPP"
        blockedData:
          parameter:
            source: Any
            name:
              matcher:
                regex: "^Location$"
                ignoreCase: false
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/ui/configuration/logout/?$"
              ignoreCase: false
      - ruleKeys:
        - "HPP"
        blockedData:
          json:
            jsonPath: "$.location"
        requestConditions:
          invert: false
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/location/(access|interpret)/?$"
              ignoreCase: false
      - ruleKeys:
        - "HPP"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "HPP"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/client/authorization/check/?$"
              ignoreCase: false
      - ruleKeys:
        - "HPP"
        blockedData:
          json:
            jsonPath: "$.queryString"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/oauth2/authorization-servers/[a-zA-Z0-9._\\-]+/authorize/?$"
              ignoreCase: false
      - ruleKeys:
        - "EXPLOIT"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      - ruleKeys:
        - "SCANNING"
        blockedData:
          json:
            jsonPath: "$['password','oldPassword','newPassword']"
      {{- if semverCompare ">=4.4" .Values.ingress.microgateway.version }}
      - ruleKeys:
        - "SSRF"
        blockedData:
          json:
            jsonPath: "$.location"
        requestConditions:
          invert: false
          method:
          - "POST"
          path:
            matcher:
              regex: "^{{ $app_values.path }}/rest/public/authentication/location/(access|interpret)/?$"
              ignoreCase: false
      {{- end }}
{{-   end }}
{{- end }}
